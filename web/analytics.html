<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Dechen Study</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #FAF8F5;
      --bg-card: #fff;
      --ink: #2c2416;
      --body: #3d3426;
      --muted: #6b5b4f;
      --primary: #8B7355;
      --primary-light: #a68a6e;
      --line: #e8e4dc;
      --shadow-sm: 0 1px 3px rgba(44, 36, 22, 0.06);
      --shadow: 0 4px 12px rgba(44, 36, 22, 0.08);
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Lora', Georgia, serif;
      background: var(--bg);
      color: var(--body);
      line-height: 1.5;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-card);
      border-bottom: 1px solid var(--line);
      padding: 1rem 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1.25rem;
      box-shadow: var(--shadow-sm);
    }
    .topbar-title {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--ink);
      margin: 0;
    }
    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .nav-links a {
      font-size: 0.9rem;
      color: var(--muted);
      text-decoration: none;
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius-sm);
      transition: background 0.15s, color 0.15s;
    }
    .nav-links a:hover {
      background: var(--line);
      color: var(--ink);
    }
    .filter-wrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-wrap label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .filter-select {
      font-family: 'Lora', Georgia, serif;
      font-size: 0.9rem;
      padding: 0.45rem 2rem 0.45rem 0.75rem;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--ink);
      cursor: pointer;
      min-width: 160px;
    }
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .section {
      scroll-margin-top: 4rem;
      margin-bottom: 3rem;
    }
    .section-title {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--ink);
      margin: 0 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--line);
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s;
    }
    .card:hover {
      box-shadow: var(--shadow);
    }
    .card.chart-card {
      padding: 1.25rem;
    }
    .chart-wrap {
      position: relative;
      height: 220px;
    }
    .chart-wrap.chart-tall { height: 280px; }
    .chart-wrap.chart-wide { height: 320px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
    }
    .stat-item {
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, var(--bg) 0%, var(--line) 100%);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
    }
    .stat-value {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 2rem;
      font-weight: 600;
      color: var(--primary);
      display: block;
      line-height: 1.2;
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .error-card {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }
    .loading-card {
      color: var(--muted);
      text-align: center;
      padding: 2rem;
    }

    @media (max-width: 640px) {
      .topbar { flex-direction: column; align-items: stretch; }
      .filter-wrap { margin-left: 0; }
      .chart-wrap { height: 200px; }
      .chart-wrap.chart-tall { height: 240px; }
      .chart-wrap.chart-wide { height: 260px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h1 class="topbar-title">Dechen Study Analytics</h1>
    <nav class="nav-links" id="nav-links" style="display:none;">
      <a href="#section-summary">Summary</a>
      <a href="#section-by-text">By text</a>
      <a href="#section-by-mode">By mode</a>
      <a href="#section-over-time">Over time</a>
      <a href="#section-over-time-by-text">Over time by text</a>
      <a href="#section-by-country">By country</a>
      <a href="#section-event-types">Event types</a>
    </nav>
    <div class="filter-wrap" id="filter-wrap" style="display:none;">
      <label for="text-filter">Filter by text</label>
      <select id="text-filter" class="filter-select" aria-label="Filter by text">
        <option value="">All texts</option>
      </select>
    </div>
    <p class="filter-note" id="filter-note" style="display:none; margin:0; font-size:0.8rem; color:var(--muted); width:100%;"></p>
  </header>

  <div id="config-msg" class="container" style="padding-top:2rem;">
    <div class="card error-card" id="config-err" style="display:none;">
      Analytics require Supabase config. Set SUPABASE_URL and SUPABASE_ANON_KEY in Vercel env vars, or create web/supabase_config.js for local dev.
    </div>
  </div>
  <div id="loading" class="container" style="padding-top:2rem;">
    <div class="card loading-card" id="loading-el">Loading analyticsâ€¦</div>
  </div>

  <main id="content" class="container" style="display:none;">
    <section id="section-summary" class="section">
      <h2 class="section-title">Summary</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value" id="total-events">0</span>
          <span class="stat-label">Total events</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="unique-sessions">0</span>
          <span class="stat-label">Unique sessions</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="unique-anon-users">0</span>
          <span class="stat-label">Unique anonymous users</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="unique-auth-users">0</span>
          <span class="stat-label">Unique logged-in users</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="quiz-attempts">0</span>
          <span class="stat-label">Quiz attempts</span>
        </div>
      </div>
    </section>

    <section id="section-by-text" class="section">
      <h2 class="section-title">Events by text</h2>
      <div class="card chart-card">
        <div class="chart-wrap">
          <canvas id="chart-text"></canvas>
        </div>
      </div>
    </section>

    <section id="section-by-mode" class="section">
      <h2 class="section-title">Events by mode</h2>
      <div class="card chart-card">
        <div class="chart-wrap chart-wide">
          <canvas id="chart-mode"></canvas>
        </div>
      </div>
    </section>

    <section id="section-over-time" class="section">
      <h2 class="section-title">Events over time (30 days)</h2>
      <div class="card chart-card">
        <div class="chart-wrap">
          <canvas id="chart-time"></canvas>
        </div>
      </div>
    </section>

    <section id="section-over-time-by-text" class="section">
      <h2 class="section-title">Events over time by text (30 days)</h2>
      <div class="card chart-card">
        <div class="chart-wrap chart-tall">
          <canvas id="chart-time-by-text"></canvas>
        </div>
      </div>
    </section>

    <section id="section-by-country" class="section">
      <h2 class="section-title">Events by country</h2>
      <div class="card chart-card">
        <div class="chart-wrap chart-wide">
          <canvas id="chart-country"></canvas>
        </div>
      </div>
    </section>

    <section id="section-event-types" class="section">
      <h2 class="section-title">Top event types</h2>
      <div class="card chart-card">
        <div class="chart-wrap chart-tall">
          <canvas id="chart-type"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script src="supabase_config.js"></script>
  <script>
(function() {
  const palette = ['#0d9488', '#2563eb', '#ca8a04', '#16a34a', '#9333ea', '#dc2626', '#4f46e5', '#0891b2'];
  let rawData = null;
  let chartInstances = {};

  function byText(rows, textId) {
    if (!textId) return rows;
    return rows.filter(r => (r.text_id || '') === textId);
  }

  function filterData(d, textId) {
    if (!d) return d;
    return {
      ...d,
      events_by_mode: d.events_by_mode,
      events_by_mode_and_text: byText(d.events_by_mode_and_text || [], textId),
      events_by_type: d.events_by_type,
      events_by_text: textId ? (d.events_by_text || []).filter(r => r.text_id === textId) : (d.events_by_text || []),
      events_over_time: d.events_over_time,
      events_over_time_by_text: byText(d.events_over_time_by_text || [], textId),
      quiz_summary: d.quiz_summary,
      totals: d.totals
    };
  }

  function destroyCharts() {
    Object.keys(chartInstances).forEach(key => {
      if (chartInstances[key]) {
        chartInstances[key].destroy();
        chartInstances[key] = null;
      }
    });
    chartInstances = {};
  }

  function renderCharts(d) {
    destroyCharts();
    const modeData = d.events_by_mode || [];
    const modeByTextData = d.events_by_mode_and_text || [];
    const timeData = d.events_over_time || [];
    const typeData = d.events_by_type || [];
    const textData = d.events_by_text || [];
    const timeByTextData = d.events_over_time_by_text || [];
    const countryData = d.events_by_country || [];

    const modeLabels = modeData.map(r => r.mode || '');
    const byModeText = {};
    modeByTextData.forEach(r => { byModeText[(r.mode || '') + '\0' + (r.text_id || '')] = r.count; });
    const textOrder = textData.map(r => r.text_id);
    const modeTextIds = [...new Set(modeByTextData.map(r => r.text_id))].filter(Boolean).sort((a, b) => {
      const i = textOrder.indexOf(a);
      const j = textOrder.indexOf(b);
      return (i === -1 ? 999 : i) - (j === -1 ? 999 : j);
    });
    const stackedModeDatasets = modeTextIds.slice(0, 8).map((textId, i) => ({
      label: textId,
      data: modeLabels.map(m => byModeText[m + '\0' + textId] || 0),
      backgroundColor: palette[i % palette.length],
      stack: 'mode'
    }));
    const hasStackedData = stackedModeDatasets.some(ds => ds.data.some(v => v > 0));

    chartInstances.mode = new Chart(document.getElementById('chart-mode'), {
      type: 'bar',
      data: {
        labels: modeLabels,
        datasets: hasStackedData ? stackedModeDatasets : [{ label: 'Events', data: modeData.map(r => r.count), backgroundColor: '#8B7355' }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: hasStackedData } },
        scales: { x: { stacked: hasStackedData }, y: { stacked: hasStackedData, beginAtZero: true } }
      }
    });

    const textColors = textData.map((_, i) => palette[i % palette.length]);
    chartInstances.text = new Chart(document.getElementById('chart-text'), {
      type: 'bar',
      data: {
        labels: textData.map(r => r.text_id || ''),
        datasets: [{ label: 'Events', data: textData.map(r => r.count), backgroundColor: textColors }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    chartInstances.time = new Chart(document.getElementById('chart-time'), {
      type: 'line',
      data: {
        labels: timeData.map(r => r.day || ''),
        datasets: [{ label: 'Events', data: timeData.map(r => r.count), borderColor: '#8B7355', fill: true, tension: 0.2 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    const days = [...new Set(timeByTextData.map(r => r.day))].sort();
    const timeTextIds = [...new Set(timeByTextData.map(r => r.text_id))].sort((a, b) => {
      const i = textOrder.indexOf(a);
      const j = textOrder.indexOf(b);
      return (i === -1 ? 999 : i) - (j === -1 ? 999 : j);
    });
    const byDayText = {};
    timeByTextData.forEach(r => { byDayText[r.day + '\0' + r.text_id] = r.count; });
    const timeByTextDatasets = timeTextIds.slice(0, 8).map((textId, i) => ({
      label: textId,
      data: days.map(d => byDayText[d + '\0' + textId] || 0),
      borderColor: palette[i % palette.length],
      fill: false,
      tension: 0.2
    }));

    chartInstances.timeByText = new Chart(document.getElementById('chart-time-by-text'), {
      type: 'line',
      data: { labels: days, datasets: timeByTextDatasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }
      }
    });

    const countryLabels = countryData.map(r => r.country_code || '');
    const countryColors = countryLabels.map((_, i) => palette[i % palette.length]);
    chartInstances.country = new Chart(document.getElementById('chart-country'), {
      type: 'bar',
      data: {
        labels: countryLabels,
        datasets: [{ label: 'Events', data: countryData.map(r => r.count), backgroundColor: countryColors }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    const typeLabels = typeData.map(r => (r.event_name || '') + (r.mode ? ' (' + r.mode + ')' : ''));
    chartInstances.type = new Chart(document.getElementById('chart-type'), {
      type: 'bar',
      data: {
        labels: typeLabels,
        datasets: [{ label: 'Events', data: typeData.map(r => r.count), backgroundColor: '#8B7355' }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true } }
      }
    });
  }

  const url = typeof window.SUPABASE_URL !== 'undefined' ? window.SUPABASE_URL : '';
  const key = typeof window.SUPABASE_ANON_KEY !== 'undefined' ? window.SUPABASE_ANON_KEY : '';
  if (!url || !key) {
    document.getElementById('loading-el').style.display = 'none';
    document.getElementById('config-err').style.display = 'block';
    document.getElementById('loading').style.display = 'block';
    return;
  }

  const supabase = window.supabase.createClient(url, key);
  supabase.rpc('analytics_dashboard_json').then(({ data, error }) => {
    document.getElementById('loading').style.display = 'none';
    if (error) {
      document.getElementById('config-err').textContent = 'Error: ' + error.message;
      document.getElementById('config-err').style.display = 'block';
      document.getElementById('config-msg').style.display = 'block';
      return;
    }
    rawData = data || {};
    document.getElementById('content').style.display = 'block';
    document.getElementById('nav-links').style.display = 'flex';
    document.getElementById('filter-wrap').style.display = 'flex';

    const textData = rawData.events_by_text || [];
    const select = document.getElementById('text-filter');
    textData.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.text_id || '';
      opt.textContent = r.text_id || '';
      select.appendChild(opt);
    });
    select.addEventListener('change', () => applyFilter(select.value || null));

    const noteEl = document.getElementById('filter-note');
    function applyFilter(textId) {
      if (!rawData) return;
      if (noteEl) {
        if (textId) {
          noteEl.style.display = 'block';
          noteEl.textContent = 'Charts filtered to: ' + textId + '. Summary counts are for all texts.';
        } else {
          noteEl.style.display = 'none';
        }
      }
      const d = filterData(rawData, textId || null);
    document.getElementById('total-events').textContent = (d.totals && d.totals.total_events) || 0;
    document.getElementById('unique-sessions').textContent = (d.totals && d.totals.unique_sessions) || 0;
    document.getElementById('unique-anon-users').textContent = (d.totals && d.totals.unique_anon_users) != null ? d.totals.unique_anon_users : 0;
    document.getElementById('unique-auth-users').textContent = (d.totals && d.totals.unique_authenticated_users) != null ? d.totals.unique_authenticated_users : 0;
    document.getElementById('quiz-attempts').textContent = (d.quiz_summary && d.quiz_summary.quiz_attempts) || 0;
    renderCharts(d);
  }

  applyFilter(null);
  });
})();
  </script>
</body>
</html>
